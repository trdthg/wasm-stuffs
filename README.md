# Wasm

## ğŸ“š ç®€ä»‹

### å†…å­˜æ’å¸ƒ
jsçš„`Object`, `Array`, `DOM Nodes`ç­‰å¯¹è±¡éƒ½å­˜å‚¨åœ¨GC Heapä¸Š
wasmçš„å†…å­˜æ˜¯å’Œjsåˆ†ç¦»çš„ï¼Œçº¿å‹æ’å¸ƒï¼Œrustçš„æ•°æ®å°±å­˜åœ¨å…¶ä¸­

### jsä¸rusté€šè®¯
wasmç›®å‰æ— æ³•ç›´æ¥è®¿é—®jsçš„GC Heap(è¿™ç‚¹å¯èƒ½ä¼šæ”¹å˜, wasmææ¡ˆæ­£å°è¯•ä¸ºwasmåŠ å…¥é«˜çº§æ•°æ®ç±»å‹), è€Œjså¯ä»¥ç›´æ¥è®¿é—®wasmçš„å†…å­˜æ•°æ®ï¼Œè™½ç„¶éœ€è¦æŠŠæ•°æ®è½¬æ¢ä¸ºå›ºå®šå¤§å°çš„buf array(u8, i32, f64 ...). wasmå‡½æ•°ä¹Ÿåªèƒ½æ¥å—è¿”å›æ ‡é‡å€¼. ä¸Šé¢çš„å†…å®¹æ„æˆäº†jså’Œwasmé€šè®¯çš„åŸºæœ¬æ¨¡å—

### wasm-bindgen
è¯¥å·¥å…·åŒ…è£…äº†rustæ•°æ®ç»“æ„ï¼Œå¹¶èƒ½å¤Ÿå°†æŒ‡é’ˆè¿”å›ç»™js, å°è£…äº†jså¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨js-api

ä½†æ˜¯ä¾ç„¶éœ€è¦è€ƒè™‘å¦‚ä½•è®¾è®¡æ•°æ®ç»“æ„ä»¥é€‚é…wasmçš„éœ€è¦

### ä¼˜åŒ–æ–¹å‘
- æœ€å°åŒ–copyæ•°æ®, åœ¨jså’Œwasmä¹‹é—´æ‹·è´æ•°æ®ä¼šå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€
    å¦‚æœjsèƒ½å¤Ÿä½¿ç”¨æŒ‡é’ˆç›´æ¥æ“ä½œwasmæ•°æ®ï¼Œå°±èƒ½å¤§å¹…å‡å°‘å¼€é”€

- æœ€å°åŒ–åºåˆ—åŒ–

ä¸€äº›å¤§å‹çš„ï¼Œé•¿æœŸå­˜åœ¨çš„æ•°æ®ç»“æ„åº”è¯¥å°†æŒ‡é’ˆæš´éœ²ç»™js

### ä¼˜åŒ–æ–¹å‘
1. consle.EndTimeè®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´

2. ç»“åˆæµè§ˆå™¨æ€§èƒ½åˆ†æå·¥å…·ï¼Œè§‚å¯Ÿå‡½æ•°è°ƒç”¨æ ˆçš„æ—¶é—´å æ¯”

3. bench
å‡†å¤‡é¡¹ç›®
- åˆ‡æ¢åˆ°`nightly`ç‰ˆæœ¬, é¡¹ç›®æ ¹ç›®å½•ä¸‹å¢åŠ `toolchain`æ–‡ä»¶ï¼Œå†™å…¥`nightly`å³å¯
- æ³¨é‡Šæ‰æ‰€æœ‰çš„`#[wasm-bindgen]`
- æ³¨é‡Šæ‰æ‰€æœ‰çš„`web-sys`è°ƒç”¨

å¼€å§‹æµ‹è¯•ï¼Œå¹¶å°†ç»“æœå¯¼å‡ºåˆ°before.txt
```shell
cargo bench | tee before.txt
```
ä»before.txtä¸­è·å–è¿è¡Œç»“æœï¼Œæ‰¾åˆ°å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ ä½¿ç”¨perfå†æ¬¡è¿è¡Œè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
```
perf record -g target/release/deps/bench-2e4b55af5ebabae8 --bench
```
æŸ¥çœ‹ç»“æœ
```
perf report
```
![](https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241137609.png)
æŒ‰ä¸‹`a`æŸ¥çœ‹æ±‡ç¼–ä»£ç çš„æ—¶é—´ç»Ÿè®¡ç»“æœ
![](https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241138801.png)
ç«Ÿç„¶ç›¸å·®äº†åå‡ å€
```
before: test universe_ticks ... bench:     215,952 ns/iter (+/- 7,814)
after : test universe_ticks ... bench:      18,912 ns/iter (+/- 5,025)
```


## ğŸ‰ å±•ç¤º
åº·ä¸ºç”Ÿå‘½æ¸¸æˆ
![å›¾ç‰‡](https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203231913525.png)

## â­ idea

- å­—ç¬¦ç”»ç½‘é¡µ